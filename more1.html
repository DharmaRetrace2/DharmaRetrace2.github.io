<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月相与日出观测站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入高精度天文算法库 Astronomy Engine -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <!-- 引入 Phosphor Icons 图标库 -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #16213e 40%, #0f3460 100%);
            background-attachment: fixed;
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* 玻璃拟态效果 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #4cc9f0;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
            outline: none;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .moon-glow {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #4cc9f0;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .font-mono-nums {
            font-family: 'JetBrains Mono', monospace;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-200">

    <div class="max-w-4xl mx-auto">
        <!-- 头部 -->
        <header class="mb-8 text-center fade-in-up" style="animation-delay: 0.1s;">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-indigo-400 mb-2">
                <i class="ph-fill ph-moon-stars inline-block mr-2"></i>星月历
            </h1>
            <p class="text-slate-400 text-sm md:text-base">计算日出节点间的月相变迁</p>
        </header>

        <!-- 输入区域 -->
        <div class="glass-panel rounded-2xl p-6 mb-8 fade-in-up" style="animation-delay: 0.2s;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2">纬度 (Latitude)</label>
                    <input type="text" id="latInput" placeholder="例如: 39.54.32N" value="39.54.32N"
                        class="input-field w-full rounded-lg px-4 py-3 text-lg font-mono-nums placeholder-slate-500">
                    <p class="text-xs text-slate-500 mt-1">格式：度.分.秒+N/S</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2">经度 (Longitude)</label>
                    <input type="text" id="lonInput" placeholder="例如: 116.23.11E" value="116.23.11E"
                        class="input-field w-full rounded-lg px-4 py-3 text-lg font-mono-nums placeholder-slate-500">
                    <p class="text-xs text-slate-500 mt-1">格式：度.分.秒+E/W</p>
                </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-4">
                <!-- 导出按钮 -->
                <button onclick="exportData()" id="exportBtn"
                    class="relative overflow-hidden group border border-blue-400/30 hover:bg-blue-500/20 text-blue-200 font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="ph-bold ph-download-simple text-xl"></i>
                    <span id="exportBtnText">导出 CSV (1000天)</span>
                    <div id="exportLoader" class="loader hidden w-5 h-5 border-2"></div>
                </button>

                <!-- 计算按钮 -->
                <button onclick="calculate()" id="calcBtn"
                    class="relative overflow-hidden group bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-blue-500/30 flex items-center justify-center gap-2">
                    <span id="btnText">开始计算 (100天)</span>
                    <div id="btnLoader" class="loader hidden"></div>
                    <i class="ph-bold ph-shooting-star group-hover:rotate-12 transition-transform"></i>
                </button>
            </div>
        </div>

        <!-- 结果展示区域 -->
        <div id="resultArea" class="hidden space-y-6">
            
            <!-- 地理信息卡片 -->
            <div class="glass-panel rounded-2xl p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 fade-in-up">
                <div>
                    <div class="flex items-center gap-2 text-blue-300 mb-1">
                        <i class="ph-fill ph-map-pin text-xl"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Current Location</span>
                    </div>
                    <h2 id="locationName" class="text-xl font-semibold text-white">正在获取位置...</h2>
                </div>
                <div class="text-right md:text-right w-full md:w-auto bg-black/20 p-3 rounded-lg">
                    <div class="text-xs text-slate-400">时区 / Timezone</div>
                    <div id="timezoneName" class="text-lg font-mono-nums text-emerald-400">UTC</div>
                </div>
            </div>

            <!-- 错误提示 -->
            <div id="errorMsg" class="hidden bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded-xl flex items-center gap-3">
                <i class="ph-fill ph-warning-circle text-2xl"></i>
                <span id="errorText"></span>
            </div>

            <!-- 时间轴容器 -->
            <div id="timelineContainer" class="space-y-4">
                <!-- JS将在这里动态生成卡片 -->
            </div>
        </div>
    </div>

    <footer class="text-center text-slate-600 mt-12 pb-8 text-xs">
        Powered by Astronomy Engine & OpenStreetMap
    </footer>

    <script>
        // 全局变量
        let currentTimezone = 'UTC';

        // 1. 解析 DMS 坐标
        function parseDMS(coordStr, type) {
            if (!coordStr) throw new Error("坐标输入为空");
            const str = coordStr.trim().toUpperCase();
            const dirLetter = str.slice(-1);
            const body = str.slice(0, -1);

            if (type === 'lat' && !['N', 'S'].includes(dirLetter)) throw new Error("纬度方向必须为 N 或 S");
            if (type === 'lon' && !['E', 'W'].includes(dirLetter)) throw new Error("经度方向必须为 E 或 W");

            const parts = body.split('.');
            if (parts.length !== 3) throw new Error(`${type === 'lat' ? '纬度' : '经度'}格式错误，应为 度.分.秒+方向`);

            const d = parseFloat(parts[0]);
            const m = parseFloat(parts[1]);
            const s = parseFloat(parts[2]);

            if (isNaN(d) || isNaN(m) || isNaN(s)) throw new Error("度、分、秒必须是数字");

            let dec = d + m / 60 + s / 3600;
            if (['S', 'W'].includes(dirLetter)) dec = -dec;

            return dec;
        }

        // 2. 获取位置名称
        async function fetchLocationName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=zh-CN`);
                const data = await response.json();
                return data.display_name || data.address.city || "未知地点";
            } catch (e) {
                console.error("Geo error:", e);
                return "位置解析失败 (网络错误)";
            }
        }

        // 3. 获取时区
        async function fetchTimezone(lat, lon) {
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                const data = await response.json();
                return data.timezone || "UTC";
            } catch (e) {
                console.warn("TZ fetch failed, default UTC");
                return "UTC";
            }
        }

        // 4. 格式化日期和时间 (YY-MM-DD 和 YY-MM-DD HH:MM:SS)
        function formatDateTimeFull(dateObj, timezone) {
            return dateObj.toLocaleString('zh-CN', {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).replace(/\//g, '-');
        }

        function formatDateOnly(dateObj, timezone) {
            return dateObj.toLocaleString('zh-CN', {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '-');
        }

        // 公用计算逻辑函数
        function performAstronomyCalculation(lat, lon, days) {
            const observer = new Astronomy.Observer(lat, lon, 0);
            const now = new Date();
            
            let sunriseList = [];
            let searchTime = now;
            
            // 1. 计算日出时刻
            for(let i=0; i <= days; i++) {
                const rise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, +1, searchTime, 1);
                if(rise) {
                    sunriseList.push(rise.date);
                    searchTime = new Date(rise.date.getTime() + 3600 * 1000); 
                } else {
                    searchTime = new Date(searchTime.getTime() + 24 * 3600 * 1000);
                    sunriseList.push(searchTime);
                }
            }

            // 构建日节点
            let nodes = [];
            for(let i=0; i < sunriseList.length - 1; i++) {
                nodes.push({
                    start: sunriseList[i],
                    end: sunriseList[i+1],
                    events: []
                });
            }

            // 2. 计算月相
            const rangeStart = nodes[0].start;
            const rangeEnd = nodes[nodes.length-1].end;
            let moonEvents = [];
            
            const phases = [
                { angle: 0, name: '新月', icon: 'ph-circle' },
                { angle: 90, name: '上弦月 (半月)', icon: 'ph-moon' },
                { angle: 180, name: '满月', icon: 'ph-circle-fill' },
                { angle: 270, name: '下弦月 (半月)', icon: 'ph-moon' }
            ];

            let searchCursor = rangeStart;
            let loopSafety = 0;
            const maxLoops = days * 5; // 增加安全循环次数以匹配天数

            while(searchCursor < rangeEnd && loopSafety < maxLoops) {
                loopSafety++;
                let candidates = [];
                for (let p of phases) {
                    const m = Astronomy.SearchMoonPhase(p.angle, searchCursor, 35); 
                    if (m) candidates.push({ time: m.date, type: p.name, angle: p.angle, raw: p });
                }
                
                candidates.sort((a, b) => a.time - b.time);
                
                if(candidates.length === 0) break;
                
                const nextEvent = candidates[0];
                if (nextEvent.time > rangeEnd) break;
                
                moonEvents.push(nextEvent);
                searchCursor = new Date(nextEvent.time.getTime() + 1000); 
            }

            // 3. 匹配
            for(let event of moonEvents) {
                for(let node of nodes) {
                    if(event.time >= node.start && event.time < node.end) {
                        node.events.push(event);
                        break;
                    }
                }
            }

            return nodes;
        }

        // 5. 核心计算逻辑 (UI显示用)
        async function calculate() {
            const latInput = document.getElementById('latInput').value;
            const lonInput = document.getElementById('lonInput').value;
            const resultArea = document.getElementById('resultArea');
            const timeline = document.getElementById('timelineContainer');
            const errorMsg = document.getElementById('errorMsg');
            const btnLoader = document.getElementById('btnLoader');
            const btnText = document.getElementById('btnText');

            errorMsg.classList.add('hidden');
            resultArea.classList.add('hidden');
            timeline.innerHTML = '';
            
            btnLoader.classList.remove('hidden');
            btnText.innerText = "计算中...";
            
            try {
                const lat = parseDMS(latInput, 'lat');
                const lon = parseDMS(lonInput, 'lon');

                const [locName, tzName] = await Promise.all([
                    fetchLocationName(lat, lon),
                    fetchTimezone(lat, lon)
                ]);

                document.getElementById('locationName').innerText = locName;
                document.getElementById('timezoneName').innerText = tzName;
                currentTimezone = tzName;

                // 执行100天计算
                const nodes = performAstronomyCalculation(lat, lon, 100);

                // 过滤并渲染
                const validNodes = nodes.filter(n => n.events.length > 0);

                if(validNodes.length === 0) {
                    timeline.innerHTML = `<div class="text-center text-slate-400 py-10">该时间段内未发现主要月相事件。</div>`;
                } else {
                    let delayCounter = 0;
                    validNodes.forEach((node) => {
                        const nodeDateStr = formatDateOnly(node.start, tzName);
                        
                        let eventsHtml = '';
                        node.events.forEach(evt => {
                            const fullEventStr = formatDateTimeFull(evt.time, tzName);
                            let iconClass = evt.raw.icon;
                            let rotateStyle = '';
                            let colorClass = 'text-yellow-100';
                            
                            if(evt.angle === 0) colorClass = 'text-slate-500 stroke-current'; 
                            if(evt.angle === 180) colorClass = 'text-yellow-200 moon-glow';
                            if(evt.angle === 270) rotateStyle = 'transform: scaleX(-1);'; 

                            eventsHtml += `
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between bg-black/20 rounded-lg p-3 mb-2 last:mb-0 border border-white/5 hover:bg-white/10 transition-colors gap-2 sm:gap-0">
                                    <div class="flex items-center gap-3">
                                        <i class="${iconClass} text-2xl ${colorClass}" style="${rotateStyle}"></i>
                                        <span class="font-medium ${evt.angle === 180 ? 'text-yellow-100' : 'text-slate-200'}">${evt.type}</span>
                                    </div>
                                    <span class="font-mono-nums text-emerald-300 bg-emerald-900/30 px-3 py-1 rounded text-sm text-center sm:text-right">
                                        ${fullEventStr}
                                    </span>
                                </div>
                            `;
                        });

                        const card = document.createElement('div');
                        card.className = 'glass-panel rounded-xl p-5 border-l-4 border-l-blue-500 fade-in-up';
                        card.style.animationDelay = `${delayCounter * 0.05}s`;
                        card.innerHTML = `
                            <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                                <div class="flex flex-col">
                                    <span class="text-lg font-bold text-blue-200 tracking-wide">${nodeDateStr}</span>
                                    <span class="text-[10px] text-slate-500 uppercase tracking-wider">日节点 (Sunrise Node)</span>
                                </div>
                            </div>
                            <div>${eventsHtml}</div>
                        `;
                        timeline.appendChild(card);
                        delayCounter++;
                    });
                }

                resultArea.classList.remove('hidden');
                setTimeout(() => {
                    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (e) {
                console.error(e);
                errorMsg.classList.remove('hidden');
                document.getElementById('errorText').innerText = e.message || "计算过程中发生未知错误";
            } finally {
                btnLoader.classList.add('hidden');
                btnText.innerText = "开始计算 (100天)";
            }
        }

        // 6. 导出数据逻辑 (1000天)
        async function exportData() {
            const latInput = document.getElementById('latInput').value;
            const lonInput = document.getElementById('lonInput').value;
            const exportLoader = document.getElementById('exportLoader');
            const exportBtnText = document.getElementById('exportBtnText');
            const errorMsg = document.getElementById('errorMsg');

            // UI 状态更新
            exportLoader.classList.remove('hidden');
            exportBtnText.innerText = "生成中...";
            errorMsg.classList.add('hidden');

            try {
                const lat = parseDMS(latInput, 'lat');
                const lon = parseDMS(lonInput, 'lon');

                // 重新获取时区，确保导出时时区信息准确（即使未先点击计算）
                // 为了效率，如果全局已经有时区，可以复用，但为了健壮性重新获取或使用默认值
                let tzName = currentTimezone;
                if(tzName === 'UTC') {
                    tzName = await fetchTimezone(lat, lon);
                }

                // 计算 1000 天
                const daysToExport = 1000;
                const nodes = performAstronomyCalculation(lat, lon, daysToExport);

                // 过滤掉无事件的日子 (events数组为空)
                const validNodes = nodes.filter(n => n.events.length > 0);

                if (validNodes.length === 0) {
                    alert("未来1000天内未发现符合条件的月相事件（这非常罕见）。");
                    return;
                }

                // 生成 CSV 内容
                // CSV Header
                let csvContent = "日出节点日期,星期,月相事件名称,月相发生时间 (当地时间),相位角度\n";

                validNodes.forEach(node => {
                    const nodeDateStr = formatDateOnly(node.start, tzName);
                    // 获取星期几
                    const weekDay = node.start.toLocaleDateString('zh-CN', { timeZone: tzName, weekday: 'long' });

                    node.events.forEach(evt => {
                        const eventTimeStr = formatDateTimeFull(evt.time, tzName);
                        // 防止CSV注入，简单替换逗号
                        const typeSafe = evt.type.replace(/,/g, ' ');
                        
                        csvContent += `${nodeDateStr},${weekDay},${typeSafe},${eventTimeStr},${evt.angle}°\n`;
                    });
                });

                // 下载文件
                // 添加 BOM (\uFEFF) 以便 Excel 正确识别 UTF-8 中文
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `月相历_1000天_${latInput}_${lonInput}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                console.error(e);
                alert("导出失败: " + (e.message || "未知错误"));
            } finally {
                exportLoader.classList.add('hidden');
                exportBtnText.innerText = "导出 CSV (1000天)";
            }
        }
    </script>
</body>
</html>

